<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Ch-M.D</title>
    <meta name="description" content="">
    <meta name="author" content="Tof">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://blog.chmd.fr/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="http://blog.chmd.fr/theme/local.css" rel="stylesheet">
    <link href="http://blog.chmd.fr/theme/pygments.css" rel="stylesheet">
    <link href="http://blog.chmd.fr/theme/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Gudea:400,400italic|Alegreya+SC' rel='stylesheet' type='text/css'>
</head>

<body>
<header class="blog-header">
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
	<a href="http://blog.chmd.fr" class="brand">Ch-M.D</a>
      </div>

      <div class="span3" id="blog-nav">
	<ul class="nav nav-pills pull-right">
	                        	   	    <li >
	      <a href="http://blog.chmd.fr/category/code.html ">code</a>
	   	    <li >
	      <a href="http://blog.chmd.fr/category/howto.html ">howto</a>
	   	    <li >
	      <a href="http://blog.chmd.fr/category/misc.html ">misc</a>
	   	</ul>
      </div>
    </div> <!-- End of fluid row-->
  </div>   <!-- End of Container-->
</header>
    
<div class="container">
    <div class="content">
    <div class="row-fluid">

        <div class="span10">
                

        

    <div class='row-fluid''>
        <div class="article-title span9">
            <a href="http://blog.chmd.fr/ssh-over-ssl-a-quick-and-minimal-config.html"><h1>SSH over SSL, a quick and minimal config.</h1></a>
        </div>
    </div>
    <div class="row-fluid">
      <div class="span2">
	<p>Fri 12 November 2010 </p>

<p style="text-align: left;">
Filed under <a href="http://blog.chmd.fr/category/howto.html">howto</a>
</p>
<p style="text-align: left;">
 
    Tags <a href="http://blog.chmd.fr/tag/apache.html">apache</a> <a href="http://blog.chmd.fr/tag/ssh.html">ssh</a> <a href="http://blog.chmd.fr/tag/ssl.html">ssl</a> <a href="http://blog.chmd.fr/tag/tunnel.html">tunnel</a> </p>
<p>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="chmduquesne">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
</p>
      </div>
      <div class="article-content span8">
	<p>So you are behind a vicious firewall that filters outgoing ssh and
vpn, and the only safe way out is SSL. In this article, I'll
describe how to SSH over SSL to a machine that runs an ssh server
and apache2. This machine will still be able to run an SSL website.
Clients will connect using a standard ssh client and proxytunnel.</p>
<h1>Server configuration</h1>
<p>I assume that:
- The server is accessible on the port 443 through the "server.com" domain
  name (otherwise using the raw ip will do the trick).
- It also runs an ssh server (but no need for the port 22 to be
  reachable).
- You already have set up certificates for SSL
- You've enabled the modules for ssl (a2enmod ssl)
- You're running the default ssl website in
  /etc/apache2/sites-available/default-ssl and it is enabled (a2ensite
  default-ssl)
- You've enabled necessary modules for proxying and using proxy connect
  methods (a2enmod proxy proxy_connect proxy_http)</p>
<h1>File /etc/apache2/sites-available/default-ssl</h1>
<p>It's minimalistic on purpose, so you can see what is really needed.</p>
<div class="highlight"><pre><span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
<span class="nt">&lt;VirtualHost</span> <span class="err">_default_:443</span><span class="nt">&gt;</span>
    # enable ssl
    SSLEngine on
    SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    # proxytunnel
    Include /etc/apache2/proxytunnel/main.conf
<span class="nt">&lt;/VirtualHost&gt;</span>
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div>


<h1>File /etc/apache2/proxytunnel/main.conf</h1>
<p>It enables forward proxying for anyone, but only if the client asks for
127.0.0.1:22 (other requests will be denied). This results in exposing the
port 22 (ssh) of your server through a proxy, in an encrypted way.</p>
<div class="highlight"><pre><span class="nx">ProxyRequests</span> <span class="k">On</span>
<span class="nx">AllowConnect</span> <span class="mi">22</span>
<span class="o">&lt;</span><span class="nx">Proxy</span> <span class="o">*&gt;</span>
    <span class="k">Order</span> <span class="nx">deny</span><span class="p">,</span><span class="nx">allow</span>
    <span class="nx">Deny</span> <span class="nb">from</span> <span class="kc">all</span>
<span class="o">&lt;/</span><span class="nx">Proxy</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">Proxy</span> <span class="mf">127.0.0.1</span><span class="o">&gt;</span>
    <span class="k">Order</span> <span class="nx">deny</span><span class="p">,</span><span class="nx">allow</span>
    <span class="nx">Allow</span> <span class="nb">from</span> <span class="kc">all</span>
<span class="o">&lt;/</span><span class="nx">Proxy</span><span class="o">&gt;</span>
</pre></div>


<h1>Client configuration</h1>
<p>I assume that:
- An ssh client is installed
- proxytunnel is installed</p>
<p>First, you'll need to test your server setting using proxytunnel alone.
Since debugging encryption problems can be tedious, at first, I suggest
you set up your server to provide the proxy in a non encrypted way,
commenting the three SSL related lines (you can switch to encrypted when
it works). Proxytunnel can "chain" two proxies (a local one, and a remote
one), but if the place you connect from does not use such a setting, here
is how you can proceed:</p>
<div class="highlight"><pre><span class="n">proxytunnel</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">p</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span> <span class="o">-</span><span class="n">v</span>
</pre></div>


<p>-v is for verbose. Replace it with -q (quiet) if it works. You can say it
works when you are prompted an ssh login. Apache2 used to have <a href="https://issues.apache.org/bugzilla/show_bug.cgi?id=29744">a bug</a>
with proxy_connect and SSL, so using encryption may require some extra
work (like patching and recompiling the mod_proxy shared libraries or
using the latest alpha).</p>
<h1>File .ssh/config</h1>
<p>Once you're done, just drop the working command line in the .ssh/config of
your clients:</p>
<div class="highlight"><pre><span class="n">Host</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span>
    <span class="n">ProxyCommand</span> <span class="n">proxytunnel</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">p</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span>
    <span class="n">DynamicForward</span> <span class="mi">1080</span>
    <span class="n">ServerAliveInterval</span> <span class="mi">60</span>
</pre></div>


<p>If you are stuck, I recommend you read <a href="http://www.saulchristie.co.uk/how-to/bypass-firewalls">this excellent article</a>. One
problem remains with this config: If the traffic is correctly monitored,
the ip of you server could be logged (even though it will be impossible to
prove you have been doing something not allowed). First, you should run an
https website on this ip (like a blog, or a code repository), in order to
make this traffic more realistic. What could also be cool would be to
chain proxies, <a href="http://lifehacker.com/5484934/run-your-own-free-proxy-through-the-google-app-engine">using for example the appengine</a>. This way your traffic
will look like it's going to google.</p> 
	<a class="btn btn-mini xsmall" href="http://blog.chmd.fr/ssh-over-ssl-a-quick-and-minimal-config.html">
          <i class="icon-comment"></i> Comment </a>
	<hr />
      </div>
      
    </div>
    
            <div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://blog.chmd.fr/tag/tunnel.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>    
 
  
        </div>
        
        
    </div>     </div> </div>

<!--footer-->
<div class="container">
  <div class="well" style="background-color: #E9EFF6">
    <div id="blog-footer">
      <div class="row-fluid">
		<div class="social span2" align="center" id="socialist">
	  <ul class="nav nav-list">
	    <li class="nav-header">
	      Social
	    </li>
	    	    <li><a href="https://twitter.com/#!chmduquesne"><i class="icon-twitter" style="color: #1f334b"></i>twitter</a></li>
	    	    <li><a href="http://resume.chmd.fr"><i class="icon-resume" style="color: #1f334b"></i>resume</a></li>
	                
	  </ul>
	</div>
		        	<div class="site-nav span2" align="center">
          <ul class="nav nav-list" id="site-links">
            <li class="nav-header"> 
              Site
            </li>
            <li><a href="http://blog.chmd.fr"><i class="icon-home" style="color: #1f334b">
                </i>Home</a></li>
            <li><a href="http://blog.chmd.fr/archives.html"><i class="icon-list" style="color: #1f334b">
                </i>Archives</a></li>
	    <li><a href="http://blog.chmd.fr/tags.html"><i class="icon-tags" style="color: #1f334b">
                </i>Tags</a></li>
	    
	                <li><a href="http://blog.chmd.fr/" rel="alternate">
                <i class="icon-rss-sign" style="color: #1f334b"></i>
                Atom Feed</a></li>
	  </ul>

        </div>

      </div> <!--end of fluid row-->
    </div> <!--end of blog-footer-->
    <hr />
    <p align="center"><a href="http://blog.chmd.fr">Ch-M.D</a>
      &copy; Tof
    Powered by <a href="github.com/getpelican/pelican">Pelican</a> and
        <a href="https://twitter.github.com/bootstrap">Twitter Bootstrap</a>. 
        Icons by <a href="http://fortawesome.github.com/Font-Awesome">Font Awesome</a> and 
        <a href="http://gregoryloucas.github.com/Font-Awesome-More">Font Awesome More</a></p>

  </div> <!--end of well -->
</div> <!--end of container -->

<!--/footer-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>


<script>var _gaq=[['_setAccount','UA-17659080-3'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>

</body>
</html>