<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="http://blog.chmd.fr/theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="http://blog.chmd.fr/theme/css/pygments.css">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>

	<link href="http://blog.chmd.fr/" type="application/atom+xml" rel="alternate" title="Ch-M.D ATOM Feed" />
	
	
			<title>Ch-M.D</title>
		<meta charset="utf-8" />
	</head>
<body>
	<section id="sidebar">
		<figure id="user_logo">
            <a href="http://blog.chmd.fr"><div class="logo">&nbsp;</div></a>
		</figure>

		<div class="user_meta">
            <h1 id="user"><a href="http://blog.chmd.fr" class="">Tof</a></h1>
			<h2></h2>
						<ul>
																								</ul>
		</div>
		<footer>
			<address>
				Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>,
		                theme by <a href="https://github.com/wting/pelican-svbtle">wting</a>.
			</address>
		</footer>
	</section>

	<section id="posts">
			<header>
		<h1>Tof's blog</h1>
		<h3>Posted Mon 11 July 2011</h3>
	</header>
	<article>
		<h1 id="title">
			<a href="http://blog.chmd.fr/ssh-over-ssl-episode-3-avoiding-using-a-patched-apache.html" rel="bookmark"
				title="Permalink to SSH over SSL, episode 3: Avoiding using a patched apache.">SSH over SSL, episode 3: Avoiding using a patched apache.</a>
		</h1>
		<p>Another episode of my adventures of firewall bypassing...</p>
<p>In order to use the http CONNECT method to tunnel ssh, you have to
configure apache as I previously showed in <a href="../ssh-over-ssl-a-quick-and-minimal-config.html">a previous post</a>.  Sadly,
the current version of apache does not allow to do it over https. There
has been a <a href="https://issues.apache.org/bugzilla/show_bug.cgi?id=29744">bug report</a> for years and various patches have been
proposed, but as far as I know, still not any of these patches made it to
the official release.</p>
<p>My solution so far was to apply the patch manually and recompile the
relevant module. Doing this for every release can be annoying, so I've
been looking for a different solution that would not involve recompiling
apache.</p>
<p>The workaround I now use is fun enough for me to talk about it here. Since
apache has no problem with the CONNECT method when SSL is not involved, I
have decided to do the SSL part by myself. Thus, I configure apache to
serve normally on the port 80, and I use stunnel to secure apache on the
port 443. Here is how I do it: I remove the SSL part of my apache config
and I add in my (normal, unencrypted) apache configuration:</p>
<div class="highlight"><pre><span class="nx">ProxyRequests</span> <span class="k">On</span>
<span class="nx">AllowConnect</span> <span class="mi">22</span>
<span class="o">&lt;</span> <span class="nx">Proxy</span> <span class="o">*&gt;</span>
    <span class="k">Order</span> <span class="nx">deny</span><span class="p">,</span><span class="nx">allow</span>
    <span class="nx">Deny</span> <span class="nb">from</span> <span class="kc">all</span>
<span class="o">&lt;/</span><span class="nx">Proxy</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">Proxy</span> <span class="mf">127.0.0.1</span><span class="o">&gt;</span>
    <span class="k">Order</span> <span class="nx">deny</span><span class="p">,</span><span class="nx">allow</span>
    <span class="nx">Allow</span> <span class="nb">from</span> <span class="kc">all</span>
<span class="o">&lt;/</span><span class="nx">Proxy</span><span class="o">&gt;</span>
</pre></div>


<p>Then, I install stunnel, and I set it up to listen on the port 443
(https) and to forward it to the port 80 (http).</p>
<div class="highlight"><pre><span class="n">cert</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">stunnel</span><span class="o">/</span><span class="n">stunnel</span><span class="p">.</span><span class="n">pem</span>
<span class="p">...</span>
<span class="p">[</span><span class="n">https</span><span class="p">]</span>
<span class="n">accept</span>  <span class="o">=</span> <span class="mi">443</span>
<span class="n">connect</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">TIMEOUTclose</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>


<p>stunnel requires a bit of configuration. From the <a href="http://www.stunnel.org/?page=docs">documentation</a>, here
is how to generate a certificate:</p>
<div class="highlight"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">stunnel</span>
<span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">new</span> <span class="o">-</span><span class="n">x509</span> <span class="o">-</span><span class="n">days</span> <span class="mi">365</span> <span class="o">-</span><span class="n">nodes</span> <span class="o">-</span><span class="n">config</span> <span class="n">stunnel</span><span class="p">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">out</span> <span class="n">stunnel</span><span class="p">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyout</span> <span class="n">stunnel</span><span class="p">.</span><span class="n">pem</span>
<span class="n">chown</span> <span class="n">stunnel</span><span class="o">:</span><span class="n">stunnel</span> <span class="n">stunnel</span><span class="p">.</span><span class="n">pem</span>
<span class="n">chmod</span> <span class="mi">600</span> <span class="n">stunnel</span><span class="p">.</span><span class="n">pem</span>
</pre></div>


<p>I also nedded to add in /etc/hosts.allow</p>
<div class="highlight"><pre><span class="n">sshd</span><span class="o">:</span> <span class="n">ALL</span>
<span class="n">stunnel</span><span class="o">:</span> <span class="n">ALL</span>
<span class="n">https</span><span class="o">:</span> <span class="n">ALL</span>
</pre></div>


<p>And that is all. I restart stunnel and httpd and I can enjoy SSH
over SSL. (actually since I did not want double encryption, I have
started to do telnet over SSL, but that is more or less the same
story).</p>
<p>Other alternatives I have considered:
- Switching from apache to another http server: it turns out I was unable
  to find any other http server supporting the http CONNECT method (at
  least thttpd, lighttpd and nginx don't support it)
- Using a perl script that serves on the port 443, waiting for the CONNECT
  method and forwarding every other message to apache (see
  <a href="http://www.karlrunge.com/x11vnc/connect_switch">connect_switch</a>)</p>
<p>I did not try this second method, but it seems rather cool. If
anyone does and has any success with it, please leave a comment
here, I am interested. I would also be interested if someone knows
any http server lighter than apache and guaranteed to support the
CONNECT method...</p>

		<div id="article_meta">
							Category:
					<a href="http://blog.chmd.fr/category/howto.html">howto</a>
										<br />Tags:
									<a href="http://blog.chmd.fr/tag/ssh.html">ssh</a>
									<a href="http://blog.chmd.fr/tag/ssl.html">ssl</a>
									<a href="http://blog.chmd.fr/tag/stunnel.html">stunnel</a>
									<a href="http://blog.chmd.fr/tag/apache.html">apache</a>
									</div>
	</article>

	<footer>
		<a href="http://blog.chmd.fr/" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>

		<div id="comments">
		<h2>Comments</h2>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_identifier = "ssh-over-ssl-episode-3-avoiding-using-a-patched-apache.html";
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = 'http://chmd.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view <a href="http://disqus.com/?ref_noscript">comments</a>.</noscript>
	</div>
	
	</section>

	<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
		try {
			var pageTracker = _gat._getTracker("UA-17659080-3");
			pageTracker._trackPageview();
		} catch(err) {}</script>
</body>
</html>