<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet/less" type="text/css" href="http://blog.chmd.fr/theme/css/style.less">
  <script src="http://blog.chmd.fr/theme/js/less-1.3.3.min.js" type="text/javascript"></script>
  <!-- <link rel="stylesheet" type="text/css" href="http://blog.chmd.fr/theme/css/style.css"> -->

  <link rel="stylesheet" type="text/css" href="http://blog.chmd.fr/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width; initial-scale=1.0">
  <meta name="author" content="Tof">
  <meta name="description" content="Posts and writings by Tof">

    <link href="http://blog.chmd.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ch-M.D Full Atom Feed" />
    
  <meta name="keywords" content="socat, ssh, ssl">

  <title>
    SSH over SSL, episode 2: replacing proxytunnel with socat  </title>

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17659080-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://blog.chmd.fr">
                <img src="http://blog.chmd.fr/theme/images/logo.png" alt="logo">
              </a>
      <h2><a href="http://blog.chmd.fr">Tof</a></h2>
      <p></p>
      <ul>
                                        <li><a href="https://twitter.com/#!chmduquesne" target="_blank">twitter</a></li>
                <li><a href="http://resume.chmd.fr" target="_blank">resume</a></li>
              </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>Posted on Mon 15 November 2010</p>
    </header>

    <article>
  <div id="article_title">
    <h3><a href="http://blog.chmd.fr/ssh-over-ssl-episode-2-replacing-proxytunnel-with-socat.html">SSH over SSL, episode 2: replacing proxytunnel with socat</a></h3>
  </div>
  <div id="article_text">
    <p>Last week, I wrote <a href="../ssh-over-ssl-a-quick-and-minimal-config.html">an article about how to quickly set up a server and a
client for doing ssh over ssl</a>.  In this article, I was using
proxytunnel, but I realized today that it could probably be replaced with
socat (socat can do almost anything)...</p>
<p>The principle is simple: Following the first part of
the tutorial, you make your server accept proxy_connect requests
to its private port localhost:22 through its public port 443,
encapsulating the whole thing in SSL (as a reminder, 22 and 443 are
respectively the standard ports for ssh and ssl).</p>
<p>We now want to configure the ssh clients in order to connect through this
ssl tunnel. I said I was configuring the clients with proxytunnel. The
exact command (in .ssh/config) was:</p>
<div class="highlight"><pre><span class="n">proxytunnel</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">p</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span>
</pre></div>


<p>I'll explain it:
- <code>-q</code> is for quiet
- <code>-E</code> is for encrypting between the proxy and us
- <code>-p</code> is for choosing the proxy
- <code>-d</code> is for requesting a destination (from the proxy point of view)</p>
<p>So basically, this means: "connect stdio to server.com on port 443 (-p
server.com:443) , in an encrypted way (-E), then from this server, require
to be connected to 127.0.0.1:22 (-d 127.0.0.1:22)".</p>
<p>For those who like to play with all sorts of streams, socat is really the
best tool ever invented. I was wondering if I could reproduce
proxytunnel's behavior with socat, and it turns out you can. Here is how
to proceed: First, create an ssl tunnel between your client's
localhost:1080 and server.com:443:</p>
<div class="highlight"><pre><span class="n">socat</span> <span class="n">TCP</span><span class="o">-</span><span class="n">LISTEN</span><span class="o">:</span><span class="mi">1080</span> <span class="n">OPENSSL</span><span class="o">:</span><span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span>
</pre></div>


<p>This way, the port 443 of server.com is now available unencrypted
on localhost:1080 Then, use socat and its proxy mode to ask for
localhost:1080 (which is actually server.com:443 unencrypted) to
connect to localhost:22 (which is then server.com:22).</p>
<div class="highlight"><pre><span class="n">socat</span> <span class="o">-</span> <span class="n">PROXY</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="n">proxyport</span><span class="o">=</span><span class="mi">1080</span>
</pre></div>


<p>Bingo! You should see the ssh prompt. For the fun, I replaced in my
.ssh/config the former</p>
<div class="highlight"><pre><span class="n">ProxyCommand</span> <span class="n">proxytunnel</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">p</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span>
</pre></div>


<p>with</p>
<div class="highlight"><pre><span class="n">ProxyCommand</span> <span class="n">socat</span> <span class="n">TCP</span><span class="o">-</span><span class="n">LISTEN</span><span class="o">:</span><span class="mi">1080</span> <span class="n">OPENSSL</span><span class="o">:</span><span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="mi">0</span> <span class="o">&amp;</span><span class="p">;</span> <span class="n">socat</span> <span class="o">-</span> <span class="n">PROXY</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="n">proxyport</span><span class="o">=</span><span class="mi">1080</span>
</pre></div>


<p>It works just fine. There is however a flaw in what I did: I use a
hardcoded port, thus I can't establish two ssh connections at the
same time. Forwarding the server.com:443 on localhost:1080 fails
the second time, since this port is already occupied by the first
connection. The best way to fix that would be to use stdio for the
proxy_connect requests, instead of a port of localhost (since the
number of these port is limited). However, with my version of socat
(1.7.1.3), I don't see how to proceed differently: the PROXY method
requires three arguments and one of them is a port. If one of my
readers has a suggestion, he/she's welcome. This remains a cool hack!</p>
<p><strong>Edit</strong>: The great <a href="https://darkpan.com/">Marco Fontani</a> gave a cool solution (see the
comments). Here is how my .ssh/config looks like:</p>
<div class="highlight"><pre><span class="n">Host</span> <span class="n">server</span><span class="p">.</span><span class="n">com</span>
    <span class="n">ProxyCommand</span> <span class="n">socat</span> <span class="n">TCP</span><span class="o">-</span><span class="n">LISTEN</span><span class="o">:</span><span class="mi">1080</span> <span class="n">OPENSSL</span><span class="o">:</span><span class="n">server</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="mi">443</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="mi">0</span> <span class="o">&amp;</span><span class="p">;</span> <span class="n">sleep</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">socat</span> <span class="o">-</span> <span class="n">PROXY</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span><span class="n">proxyport</span><span class="o">=</span><span class="mi">1080</span>
    <span class="n">DynamicForward</span> <span class="mi">1080</span>
    <span class="n">ServerAliveInterval</span> <span class="mi">60</span>
    <span class="n">ControlMaster</span> <span class="k">auto</span>
    <span class="n">ControlPath</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">tmp</span><span class="o">/%</span><span class="n">h_</span><span class="o">%</span><span class="n">p_</span><span class="o">%</span><span class="n">r</span>
</pre></div>
  </div>
  <div id="article_meta">
    <p>Category: <a href="http://blog.chmd.fr/category/howto.html">howto</a></p>
        <p>Tags:
            <a href="http://blog.chmd.fr/tag/socat.html">socat</a>,            <a href="http://blog.chmd.fr/tag/ssh.html">ssh</a>,            <a href="http://blog.chmd.fr/tag/ssl.html">ssl</a>          </p>
      </div>
</article>

    <footer>
      <p><a href="http://blog.chmd.fr/" class="button_accent">&larr; Back to Index</a></p>
    </footer>

    <div id="ending_message">
      <p>&copy Giulio Fidente. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. You can fork the theme on <a href="https://github.com/giulivo/pelican-svbhack" target="_blank">github</a>.</p>
    </div>
  </main>
</body>
</html>